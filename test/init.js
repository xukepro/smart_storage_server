const config = require("../config");
const log4js = require("log4js");
var tags = [];
var rcoords = {};
const MongoClient = require("../lib/mongoClient");
const mongoClient = new MongoClient(config.mongodb, log4js, tags, rcoords);

const aIds = {
  "904E9140F915": [23.0, 24.0, -50.55, 1.726],
  "904E9140F916": [36.0, 24.0, -50.55, 1.726],
  "904E9140F917": [23.0, 38.0, -50.55, 1.726],
  "904E9140F918": [36.0, 38.0, -50.55, 1.726],
  "904E9140F919": [5.0, 10.0, -50.55, 1.726],

  "10001-00436": [9.1, 13.7, -54.0, 1.66],
  "10001-00434": [9.1, 9.5, -54.0, 1.66],
  "10001-00433": [14.2, 13.7, -54.0, 1.66],
  "10001-00432": [14.2, 9.5, -54.0, 1.66],
  "10001-00438": [5.8, 11.6, -54.0, 1.66],

  "10001-00430": [12.75, 15.3, -54.0, 1.66],
  "10001-00423": [9.7, 15.3, -54.0, 1.66],
  "10001-00678": [6.4, 15.3, -54.0, 1.66],

  "10001-00427": [12.75, 8.55, -54.0, 1.66],
  "10001-00422": [9.7, 7.9, -54.0, 1.66],
  "10001-00421": [6.4, 8.55, -54.0, 1.66],

  "10001-00428": [9.7, 7.25, -54.0, 1.66],
  "10001-00429": [4.7, 7.25, -54.0, 1.66],

  "10001-00424": [9.7, 4.65, -54.0, 1.66],
  "10001-00425": [4.7, 4.65, -54.0, 1.66],

  "10001-00504": [12.65, 7.85, -59.34, 1.221],
  "10001-00512": [12.65, 4.55, -59.34, 1.221],
  "10001-00510": [12.65, 1.65, -59.34, 1.221],
  "10001-00519": [15.1, 7.85, -59.34, 1.221],
  "10001-00520": [15.1, 4.55, -59.34, 1.221],
  "10001-00502": [15.1, 1.65, -59.34, 1.221],

  "10001-19352": [23.2, 10.4, -69.34, 1.221],
  "10001-19353": [29.75, 10.4, -69.34, 1.221],
  "10001-19345": [23.2, 17.0, -69.34, 1.221],
  "10001-19346": [29.75, 17.0, -69.34, 1.221],
  "10001-19109": [23.2, 24.0, -69.34, 1.221],
  "10001-19785": [29.75, 24.0, -69.34, 1.221],
  "10001-19833": [23.2, 31.0, -69.34, 1.379],
  "10001-19899": [29.75, 31.0, -69.34, 1.221],
  "10001-19894": [23.2, 37.85, -69.34, 1.221],
  "10001-19893": [29.75, 37.85, -69.34, 1.221],
  "10001-19061": [23.2, 45.05, -69.34, 1.221],
  "10001-19633": [29.75, 45.05, -69.34, 1.221],
  "10001-19115": [23.0, 31.2, -69.34, 1.221],
  "10001-19113": [18.3, 37.55, -69.34, 1.221],
  "10001-19112": [13.25, 31.2, -69.34, 1.221],
  "10001-19105": [13.25, 37.55, -69.34, 1.221],
  "10001-19712": [7.6, 31.2, -69.34, 1.221],
  "10001-19720": [5.75, 37.55, -69.34, 1.221],
  "10001-19104": [9.45, 37.55, -69.34, 1.221],
  "10001-19709": [6.85, 29.25, -69.34, 1.221],
  "10001-19710": [0.7, 29.25, -69.34, 1.221],
  "10001-19955": [3.45, 24.25, -69.34, 1.221],
  "10001-19717": [0.7, 19.25, -69.34, 1.221],
  "10001-19954": [3.45, 14.25, -69.34, 1.221],
  "10001-19718": [0.7, 9.25, -69.34, 1.221],
  "10001-19949": [3.45, 5.25, -69.34, 1.221]
};
const tIds = [
  { tId: "10001-04096", username: "xuke" },
  { tId: "10001-04097", username: "xuke" },
  { tId: "10001-04098", username: "xuke" },
  { tId: "10001-04099", username: "abcd" },
  { tId: "10001-04100", username: "abcd" },
  { tId: "10001-04101", username: "abcd" }
];
const users = [
  { username: "xuke", password: "123456", email: "2574290343@qq.com" },
  { username: "abcd", password: "123456", email: "10201947@qq.com" }
];
const adminUser = { username: "admin", password: "123456" };

Promise.all([
  mongoClient.Anchors.deleteMany(),
  mongoClient.Tags.deleteMany(),
  mongoClient.User.deleteMany(),
  mongoClient.AdminUser.deleteMany()
])
  .then(() => {
    /* 添加管理员和用户 */
    return Promise.all([
      mongoClient.AdminUser(adminUser).save(),
      mongoClient.User(users[0]).save(),
      mongoClient.User(users[1]).save()
    ]);
  })
  .then(() => {
    /* 添加锚点 */
    for (let row of Object.keys(aIds)) {
      mongoClient.Anchors({ aId: row, coords: aIds[row] }).save();
    }
  })
  .then(() => {
    /* 添加标签，建立关联 */
    const createTag = (tId, username) => {
      mongoClient.User.findOne({ username })
        .then((user) => {
          return mongoClient
            .Tags({ tId: tId, user: user._id })
            .save()
            .then((tag) => {
              user.tags.push(tag._id);
              return user.save();
            });
        });
    };
    for (let item of tIds) {
      console.log(item);
      createTag(item.tId, item.username);
    }
  })
  .catch((err) => {
    console.log(err);
  });
